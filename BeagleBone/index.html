<!DOCTYPE html>
<html>
<head>
    <title>ROV GCS</title>
    <script src = "/socket.io/socket.io.js" ></script>
    <link rel="stylesheet" type="text/css" href="css/controlstation.css">
    
    <script>
        const down = 1;
        const up = 2;
        const backward = 3;
        const forward = 4;
        const right = 5;
        const left = 6;
        const pitch_up = 7;
        const pitch_down = 8;
        const yaw_right = 9;
        const yaw_left = 10;
        
        const key_up_arrow = 38;
        const key_down_arrow = 40;
        const key_left_arrow = 37;
        const key_right_arrow = 39;
        const key_spacebar = 32;
        const key_shift = 16;
        const key_w = 87;
        const key_s = 83;
        const key_a = 65;
        const key_d = 68;
        
        // Establishing connection with server
        var socket = io.connect();
        var keymap = [];
        var key_dict = [];
        var keyvector = 0;

        function create_key_dict() {
            key_dict[key_up_arrow] = forward;
            key_dict[key_down_arrow] = backward;
            key_dict[key_left_arrow] = left;
            key_dict[key_right_arrow] = right;
            key_dict[key_spacebar] = down;
            key_dict[key_shift] = up;
            key_dict[key_w] = pitch_up;
            key_dict[key_s] = pitch_down;
            key_dict[key_a] = yaw_left;
            key_dict[key_d] = yaw_right;
        }
        
        create_key_dict();
        
        window.addEventListener("keydown", handleKeyPressed, false);
        window.addEventListener("keyup", handleKeyReleased, false);
        
        /* Converts Decimal to Binary */
        function bin(dec) {
           return (dec >>> 0).toString(2);
        }
        
        /* Sets Given Bit in Command Vector */
        function set_bit(bitshift) {
            keyvector |= 1 << bitshift;
        }
        
        function clear_bit(bitshift) {
            keyvector &= ~(1 << bitshift);
        }
        
        function updateKeyVector() {
            var state = '{"state":';
            
            for (var key in key_dict) {
                if (keymap[key] == true) {
                    set_bit(key_dict[key]);
                }
                else {
                    clear_bit(key_dict[key]);
                }
            }
            state += keyvector + '}';
            console.log(bin(keyvector));
            socket.emit('updateKeyVector', state);
        }
        
        function handleKeyPressed(event) {
            keymap[event.keyCode] = true;
            updateKeyVector();
        }
        
        function handleKeyReleased(event) {
            keymap[event.keyCode] = false;
            updateKeyVector();
        }
        
        function changeLEDs(state) {
            if (state == 0) {
                // Emit message changing the state to 0
                socket.emit('changeLEDs', '{"state":0}');
                // Change led status to on 
                document.getElementById("lights").innerHTML = "Lights Status: OFF";
            }
            else if (state == 1) {
                // Emit message changing the state to 4
                socket.emit('changeLEDs', '{"state":1}');
                // Change led status to off
                document.getElementById("lights").innerHTML = "Lights Status: ON";
            }
        }
        
        function handleRadioButtons(speed) {
           socket.emit('handleRadioButtons', '{"state":' + speed + '}');
           document.getElementById("speed").innerHTML = "Motor Speed: " + speed;
        }

        
        function initROV() {
           //default motor speed init of 1 
           handleRadioButtons(1);
        
           //default LED setting set to "off" position
           changeLEDs(0);
        
           //default motor direction initialize to IDLE 
           changeMotorDirection(0);
        }
    </script>
    
</head>

<body onload="initROV()">
    <div style="margin: 30px">
        <h1 align="center" class="shadow">ROV CONTROL STATION</h1>
        <table>
            <tr>
                <td style="padding: 10px" width="70%">
                    <!--<img src="img/SeaFloor.jpg" style="width: 100%;">-->
                    <img src="http://192.168.254.2:8082/?action=stream" style="width:100%" />
                </td>

                <td style="padding: 10px" width="30%" align="left" valign="top">
                    <p id="outputStatus">Vehicle Status: IDLE</p>
                    <br>
                    <p id="lights" style="margin: 0 0 0px;">Lights Status: OFF</p>
                    <button type="button" onclick="changeLEDs(1);">ON</button>
                    <button type="button" onclick="changeLEDs(0);">OFF</button>
                    <p id="speed">Motor Speed: 0</p>
                    
                    <form>
                        <input type="range" background="white;" name="speed" min="1" max="7" step="1" onclick="handleRadioButtons(1)"><br>
                        <input type="radio" name="speed" value="1" checked onclick = "handleRadioButtons(1)"> 1<br>
                        <input type="radio" name="speed" value="2" onclick = "handleRadioButtons(2)"> 2<br>
                        <input type="radio" name="speed" value="3" onclick = "handleRadioButtons(3)"> 3<br>  
                        <input type="radio" name="speed" value="4" onclick = "handleRadioButtons(4)"> 4<br>  
                        <input type="radio" name="speed" value="5" onclick = "handleRadioButtons(5)"> 5<br>  
                        <input type="radio" name="speed" value="6" onclick = "handleRadioButtons(6)"> 6<br>  
                        <input type="radio" name="speed" value="7" onclick = "handleRadioButtons(7)"> 7<br>  
                    </form> 
                </td>
            </tr>
        </table>
    </div>
  
</body>
</html>
